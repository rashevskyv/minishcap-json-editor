# --- START OF FILE task.md ---
# Завдання: Виправлення "AI Variations for Selection" та анімація прогрес-бару

## 1. Опис проблеми

Поточна реалізація функціоналу "AI Variations" має кілька критичних проблем:

1.  **Падіння програми:** Спроба викликати "AI Variations for Selected" через контекстне меню в полі редагування призводить до збою програми через відсутність методу `generate_variation_for_selection` у `handlers/translation_handler.py`.
2.  **Некоректна логіка:** Функціонал має генерувати варіації лише для виділеного користувачем фрагмента тексту, використовуючи весь рядок як контекст для AI. Поточна логіка для цього не призначена.
3.  **Статичний прогрес-бар:** Вікно, що з'являється під час очікування відповіді від AI, не анімоване. Воно показує статичний стан, що може створювати враження, ніби програма "зависла".

## 2. План реалізації

### Крок 1: Анімація прогрес-бару

- **Файл:** `handlers/translation/translation_ui_handler.py`
- **Завдання:** Модифікувати `QProgressDialog` у методі `show_progress_indicator`, встановивши діапазон значень `(0, 0)`. Це активує вбудований у Qt режим "busy indicator", який відображає безперервну анімацію.
- **Деталі:**
    - У `show_progress_indicator` змінити `setRange(0, 100)` на `setRange(0, 0)`.
    - Видалити метод `update_progress_indicator`, оскільки він більше не потрібен.
    - Прибрати виклики `update_progress_indicator` з `handlers/translation_handler.py`.

### Крок 2: Виправлення падіння та реалізація логіки варіацій для виділеного тексту

- **Файл:** `handlers/translation_handler.py`
- **Завдання:**
    1.  Створити відсутній метод `generate_variation_for_selection`.
    2.  Реалізувати в ньому логіку отримання виділеного тексту та повного тексту з поля `edited_text_edit`.
    3.  Створити новий метод `_request_inline_variation_candidates` для надсилання спеціалізованого запиту до AI.

- **Файл:** `handlers/translation/ai_prompt_composer.py`
- **Завдання:**
    1.  Оновити метод `compose_messages`, щоб він приймав новий `request_type='inline_variation'`.
    2.  Для цього типу запиту формувати спеціальний промпт, який міститиме:
        - Повний текст рядка (для контексту).
        - Виділений фрагмент (як ціль для генерації варіацій).
        - Чітку інструкцію для AI: "згенеруй варіації лише для цього фрагмента".

- **Файл:** `handlers/translation/translation_ui_handler.py`
- **Завдання:**
    1.  Створити новий метод `apply_inline_variation`.
    2.  Цей метод має замінювати *лише виділений текст* у `edited_text_edit` на варіант, обраний користувачем, не зачіпаючи решту рядка.

- **Файл:** `components/LineNumberedTextEdit.py`
- **Завдання:** Переконатися, що контекстне меню коректно підключене до нового методу `generate_variation_for_selection` (поточний код вже робить це, але перевірка не завадить).

## 3. Очікуваний результат

- Програма не падає при виклику варіацій для виділеного тексту.
- AI отримує коректний запит (повний текст + виділення) і повертає релевантні варіації саме для виділеного фрагмента.
- Після вибору варіації в діалоговому вікні замінюється лише виділений текст.
- Під час усіх AI-запитів відображається анімований прогрес-бар, що інформує користувача про очікування.
---